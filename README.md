# Y_lab_fastapi

## **Задание 1:**
<details>
  <summary> Описание и установка </summary>

  Написать проект на FastAPI с использованием PostgreSQL в качестве БД. В проекте следует реализовать REST API по работе с меню ресторана, все CRUD операции. Даны 3 сущности: Меню, Подменю, Блюдо.

**Зависимости:**

  - У меню есть подменю, которые к ней привязаны.
    - У подменю есть блюда.

**Условия:**

  - Блюдо не может быть привязано напрямую к меню, минуя подменю.
    - Блюдо не может находиться в 2-х подменю одновременно.
    - Подменю не может находиться в 2-х меню одновременно.
    - Если удалить меню, должны удалиться все подменю и блюда этого меню.
    - Если удалить подменю, должны удалиться все блюда этого подменю.
    - Цены блюд выводить с округлением до 2 знаков после запятой.
    - Во время выдачи списка меню, для каждого меню добавлять кол-во подменю и блюд в этом меню.
    - Во время выдачи списка подменю, для каждого подменю добавлять кол-во блюд в этом подменю.


**УСТАНОВКА:**

1. Поднимаем БД через докер. Для этого в терминале пишем команду

`docker run --name some-postgres -p 5432:5432 -e POSTGRES_PASSWORD=y_lab -d postgres`

3. Копируем проект к себе.

4. Добавляем зависимости. Для этого заходим в проект и терминале прописываем

`pip install -r requirements.txt`

4. Далее запускаем нашу программу

`python main.py`
или
`python3 main.py`

Ждем когда программа запустится и можем тестить.

</details>



## **Задание 2**

<details>
    <summary> NoSQL, Docker, Тестирование </summary>


В этом домашнем задании надо написать тесты для ранее разработанных ендпоинтов вашего API после Вебинара №1.

Обернуть программные компоненты в контейнеры. Контейнеры должны запускаться по одной команде “docker-compose up -d” или той которая описана вами в readme.md.

Образы для Docker:

    (API) python:3.10-slim

    (DB) postgres:15.1-alpine

1. Написать CRUD тесты для ранее разработанного API с помощью библиотеки pytest

2. Подготовить отдельный контейнер для запуска тестов. Команду для запуска указать в README.md

3. \* Реализовать вывод количества подменю и блюд для Меню через один (сложный) ORM запрос.

4. ** Реализовать тестовый сценарий «Проверка кол-ва блюд и подменю в меню» из Postman с помощью pytest

Если FastAPI синхронное - тесты синхронные, Если асинхронное - тесты асинхронные


_*Оборачиваем приложение в докер._

_**CRUD – create/update/retrieve/delete._

# **Запуск приложения и прогон тестов**

Про тесты: всего 4 теста, как в postman'е:

первый тест (test_menu_crud) - тест меню, второй (test_submenu_crud) - тест субменю, третий (test_dishes_crud) - тест блюд, четверты (test_count) - проверка на количество блюд.

* Клонируем проект из Git. Для этого вводим команду

`git clone https://github.com/gglo0ol/Y_lab_fastapi`

* Заходим в папку с проектом.
* \* Для запуска тестов вводим в терминале команду

`docker compose -f docker-compose-test.yml up -d && docker logs --follow backend && docker compose -f docker-compose-test.yml down -v`

при этом поднимается тестовая БД и логи тестов у нас будут отображаться в терминале

* Чтобы запустить само приложение с БД

`docker compose up -d`

* Прложение будет доступно по ссылке

`http://0.0.0.0:8000/docs`

* Чтобы завершить выполнение

`docker compose down -v`

При этом удалятся все временные файлы

### Пункт 3 задания ( Реализовать вывод количества подменю и блюд для Меню через один (сложный) ORM запрос) выполнен в логике модуля menus/crud, а именно в функции get_submenu_and_dishes_count.
#### Так же добавлен "хендлер" для отображения данных для конкретного меню.

![img_3.png](img_3.png)

</details>

## Задание 3


<details>
<summary> Паттерны и принципы разработки </summary>
<details>
<summary>Описание</summary>
1.Вынести бизнес логику и запросы в БД в отдельные слои приложения.

2.Добавить кэширование запросов к API с использованием Redis. Не забыть про инвалидацию кэша.

3.Добавить pre-commit хуки в проект. Файл yaml будет прикреплен к ДЗ.

4.Покрыть проект type hints (тайпхинтами)

5.* Описать ручки API в соответствий c OpenAPI

6.** Реализовать в тестах аналог Django reverse() для FastAPI

Требования:

●Код должен проходить все линтеры.

●Код должен соответствовать принципам SOLID, DRY, KISS.

●Проект должен запускаться по одной команде (докер).

●Проект должен проходить все Postman тесты (коллекция с Вебинара №1).

●Тесты написанные вами после Вебинара №2, должны быть актуальны, запускать и успешно проходить

Дополнительно:
Контейнеры с проектом и с тестами запускаются разными командами.
</details>
<details>
<summary>Установка</summary>
* Клонируем проект из Git. Для этого вводим команду

`git clone https://github.com/gglo0ol/Y_lab_fastapi`

* Заходим в папку с проектом.
* \* Для запуска тестов вводим в терминале команду

`docker compose -f docker-compose-test.yml up -d && docker logs --follow backend && docker compose -f docker-compose-test.yml down -v`

при этом поднимается тестовая БД и логи тестов у нас будут отображаться в терминале

* Чтобы запустить само приложение с БД

`docker compose up -d`

* Прложение будет доступно по ссылке

`http://0.0.0.0:8000/docs`

* Чтобы завершить выполнение

`docker compose down -v`

Чтобы установить pre-commit хуки, нужно выполнить команду

` pre-commit run --all-files`

При этом удалятся все временные файлы

### Пункт 6 (функция reverse) реализована в файле tests/conftest.py:

    def get_routs() -> dict:
        result = {rout.endpoint.__name__: rout.path for rout in app.routes}
        return result

    def reverse(function: Callable, **kwargs) -> str:
        routes = get_routs()
        path = routes[function.__name__]
        return path.format(**kwargs)
</details>





</details>


## Задание 4.
<details>
<summary>Многопроцессорность, асинхронность</summary>

<details>
<summary>Описание</summary>
В этом домашнем задании необходимо:
1.Переписать текущее FastAPI приложение на асинхронное выполнение

2.Добавить в проект фоновую задачу с помощью Celery + RabbitMQ.

3.Добавить эндпоинт (GET) для вывода всех меню со всеми связанными подменю и со всеми связанными блюдами.

4.Реализовать инвалидация кэша в background task (встроено в FastAPI)

5.* Обновление меню из google sheets раз в 15 сек.

6.** Блюда по акции. Размер скидки (%) указывается в столбце G файла Menu.xlsx

Фоновая задача: синхронизация Excel документа и БД.
   В проекте создаем папку admin. В эту папку кладем файл Menu.xlsx (будет прикреплен к ДЗ). Не забываем запушить в гит.
   При внесении изменений в файл все изменения должны отображаться в БД. Периодичность обновления 15 сек. Удалять БД при каждом обновлении – нельзя. 


Требования:

●Данные меню, подменю, блюд для нового эндпоинта должны доставаться одним ORM-запросом в БД (использовать подзапросы и агрегирующие функций SQL).

●Проект должен запускаться одной командой

●Проект должен соответствовать требованиям всех предыдущих вебинаров. (Не забыть добавить тесты для нового API эндпоинта)

Просьба:

•Причесать проект по максимуму

•В Readme описать все задания со звездочкой, которые были реализованы и где в проекте они расположены.

•Пишите комментарии при сдаче ДЗ. Любые важные моменты.

</details>

<details>
<summary>Установка</summary>

Синхронизация с файлом Menu осуществляется из локального хранилища (файл Menu.xlsx находится по пути application/admin/Menu.xlsx).
Синхранизация происходит каждые 15 секунд.

Программа изначальна запускается с фоновым обновлением из файла Menu.xlsx. Чтобы запустить приложение с возможностью в ручную
прогнать тесты из postmana нужно иправить значение переменно1 в файле .env (CELERY_STATUS=false) или отключить celery вручную.

Id позииций в файле Menu.xlsx должны быть UUID формата, иначе будет ошибка при обновлении данных.

* Клонируем проект из Git. Для этого вводим команду

`git clone https://github.com/gglo0ol/Y_lab_fastapi`

* Заходим в папку с проектом.
* \* Для запуска тестов вводим в терминале команду

`docker compose -f docker-compose-test.yml up -d && docker logs --follow backend && docker compose -f docker-compose-test.yml down -v`

при этом поднимается тестовая БД и логи тестов у нас будут отображаться в терминале

* Чтобы запустить само приложение с БД

`docker compose up -d`

* Прложение будет доступно по ссылке

`http://0.0.0.0:8000/docs`

* Чтобы завершить выполнение

`docker compose down -v`

Чтобы установить pre-commit хуки, нужно выполнить команду

` pre-commit run --all-files`

При этом удалятся все временные файлы


</details>
</details>